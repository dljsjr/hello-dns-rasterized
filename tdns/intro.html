<html><head><meta charset="utf-8" emacsmode="-*- markdown -*-">
                            </head><body id="md" style="visibility: visible;"><meta charset="UTF-8"><meta http-equiv="content-type" content="text/html;charset=UTF-8"><meta name="viewport" content="width=600, initial-scale=1"><style>body{max-width:680px;margin:auto;padding:20px;text-align:justify;line-height:140%;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-smoothing:antialiased;color:#222;font-family:Palatino,Georgia,"Times New Roman",serif}</style><style>@media print{*{-webkit-print-color-adjust:exact;text-shadow:none !important}}body{counter-reset: h1 paragraph line item list-item}@page{margin:0;size:auto}#mdContextMenu{position:absolute;background:#383838;cursor:default;border:1px solid #999;color:#fff;padding:4px 0px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,"Helvetica Neue",sans-serif;font-size:85%;font-weight:600;border-radius:4px;box-shadow:0px 3px 10px rgba(0,0,0,35%)}#mdContextMenu div{padding:0px 20px}#mdContextMenu div:hover{background:#1659d1}.md code,.md pre{font-family:Menlo,Consolas,monospace;font-size:85%;text-align:left;line-height:140%}.md .mediumToc code,.md longToc code,.md .shortToc code,.md h1 code,.md h2 code,.md h3 code,.md h4 code,.md h5 code,.md h6 code{font-size:unset}.md div.title{font-size:26px;font-weight:800;line-height:120%;text-align:center}.md div.afterTitles{height:10px}.md div.subtitle{text-align:center}.md iframe.textinsert, .md object.textinsert,.md iframe:not(.markdeep){display:block;margin-top:10px;margin-bottom:10px;width:100%;height:75vh;border:1px solid #000;border-radius:4px;background:#f5f5f4}.md .image{display:inline-block}.md img{max-width:100%;page-break-inside:avoid}.md li{text-align:left;text-indent:0}.md pre.listing {width:100%;tab-size:4;-moz-tab-size:4;-o-tab-size:4;counter-reset:line;overflow-x:auto;resize:horizontal}.md pre.listing .linenumbers span.line:before{width:30px;margin-left:-28px;font-size:80%;text-align:right;counter-increment:line;content:counter(line);display:inline-block;padding-right:13px;margin-right:8px;color:#ccc}.md div.tilde{margin:20px 0 -10px;text-align:center}.md .imagecaption,.md .tablecaption,.md .listingcaption{display:inline-block;margin:7px 5px 12px;text-align:justify;font-style:italic}.md img.pixel{image-rendering:-moz-crisp-edges;image-rendering:pixelated}.md blockquote.fancyquote{margin:25px 0 25px;text-align:left;line-height:160%}.md blockquote.fancyquote::before{content:"“";color:#DDD;font-family:Times New Roman;font-size:45px;line-height:0;margin-right:6px;vertical-align:-0.3em}.md span.fancyquote{font-size:118%;color:#777;font-style:italic}.md span.fancyquote::after{content:"”";font-style:normal;color:#DDD;font-family:Times New Roman;font-size:45px;line-height:0;margin-left:6px;vertical-align:-0.3em}.md blockquote.fancyquote .author{width:100%;margin-top:10px;display:inline-block;text-align:right}.md small{font-size:60%}.md big{font-size:150%}.md div.title,.md contents,.md .tocHeader,.md h1,.md h2,.md h3,.md h4,.md h5,.md h6,.md .shortTOC,.md .mediumTOC,.md .nonumberh1,.md .nonumberh2,.md .nonumberh3,.md .nonumberh4,.md .nonumberh5,.md .nonumberh6{font-family:Verdana,Helvetica,Arial,sans-serif;margin:13.4px 0 13.4px;padding:15px 0 3px;border-top:none;clear:both}.md .tocTop {display:none}.md h1,.md h2,.md h3,.md h4,.md h5,.md h6,.md .nonumberh1,.md .nonumberh2,.md .nonumberh3,.md .nonumberh4,.md .nonumberh5,.md .nonumberh6{page-break-after:avoid;break-after:avoid}.md svg.diagram{display:block;font-family:Menlo,Consolas,monospace;font-size:85%;text-align:center;stroke-linecap:round;stroke-width:2px;page-break-inside:avoid;stroke:#000;fill:#000}.md svg.diagram .opendot{fill:#fff}.md svg.diagram .shadeddot{fill:#CCC}.md svg.diagram .dotteddot{stroke:#000;stroke-dasharray:4;fill:none}.md svg.diagram text{stroke:none}@media print{@page{margin:1in 5mm;transform: scale(150%)}}@media print{.md .pagebreak{page-break-after:always;visibility:hidden}}.md a{font-family:Georgia,Palatino,'Times New Roman'}.md h1,.md .tocHeader,.md .nonumberh1{border-bottom:3px solid;font-size:20px;font-weight:bold;}.md h1,.md .nonumberh1{counter-reset:h2 h3 h4 h5 h6}.md h2,.md .nonumberh2{counter-reset:h3 h4 h5 h6;border-bottom:2px solid #999;color:#555;font-weight:bold;font-size:18px;}.md h3,.md h4,.md h5,.md h6,.md .nonumberh3,.md .nonumberh4,.md .nonumberh5,.md .nonumberh6{font-family:Verdana,Helvetica,Arial,sans-serif;color:#555;font-size:16px;}.md h3{counter-reset:h4 h5 h6}.md h4{counter-reset:h5 h6}.md h5{counter-reset:h6}.md div.table{margin:16px 0 16px 0}.md table{border-collapse:collapse;line-height:140%;page-break-inside:avoid}.md table.table{margin:auto}.md table.calendar{width:100%;margin:auto;font-size:11px;font-family:Verdana,Helvetica,Arial,sans-serif}.md table.calendar th{font-size:16px}.md .today{background:#ECF8FA}.md .calendar .parenthesized{color:#999;font-style:italic}.md table.table th{color:#FFF;background-color:#AAA;border:1px solid #888;padding:8px 15px 8px 15px}.md table.table td{padding:5px 15px 5px 15px;border:1px solid #888}.md table.table tr:nth-child(even){background:#EEE}.md pre.tilde{border-top: 1px solid #CCC;border-bottom: 1px solid #CCC;padding: 5px 0 5px 20px;margin:0 0 0 0;background:#FCFCFC;page-break-inside:avoid}.md a.target{width:0px;height:0px;visibility:hidden;font-size:0px;display:inline-block}.md a:link, .md a:visited{color:#38A;text-decoration:none}.md a:link:hover{text-decoration:underline}.md dt{font-weight:700}.md dl>dd{margin-top:-8px; margin-bottom:8px}.md dl>table{margin:35px 0 30px}.md code{page-break-inside:avoid;} @media print{.md .listing code{white-space:pre-wrap}}.md .endnote{font-size:13px;line-height:15px;padding-left:10px;text-indent:-10px}.md .bib{padding-left:80px;text-indent:-80px;text-align:left}.markdeepFooter{font-size:9px;text-align:right;padding-top:80px;color:#999}.md .mediumTOC{float:right;font-size:12px;line-height:15px;border-left:1px solid #CCC;padding-left:15px;margin:15px 0px 15px 25px}.md .mediumTOC .level1{font-weight:600}.md .longTOC .level1{font-weight:600;display:block;padding-top:12px;margin:0 0 -20px}.md .shortTOC{text-align:center;font-weight:bold;margin-top:15px;font-size:14px}.md .img-attrib-container .img-attrib{font-size:50%;line-height:120%;writing-mode:vertical-rl;position:absolute;bottom:0;right:0;padding:8px 4px;color:#FFF;background-color:rgba(0,0,0,.3)}.md .img-attrib-container .img-attrib a{color:#FFF;text-decoration:none}.md .admonition{position:relative;margin:1em 0;padding:.4rem 1rem;border-radius:.2rem;border-left:2.5rem solid rgba(68,138,255,.4);background-color:rgba(68,138,255,.15);}.md .admonition-title{font-weight:bold;border-bottom:solid 1px rgba(68,138,255,.4);padding-bottom:4px;margin-bottom:4px;margin-left: -1rem;padding-left:1rem;margin-right:-1rem;border-color:rgba(68,138,255,.4)}.md .admonition.tip{border-left:2.5rem solid rgba(50,255,90,.4);background-color:rgba(50,255,90,.15)}.md .admonition.tip::before{content:"\24d8";font-weight:bold;font-size:150%;position:relative;top:3px;color:rgba(26,128,46,.8);left:-2.95rem;display:block;width:0;height:0}.md .admonition.tip>.admonition-title{border-color:rgba(50,255,90,.4)}.md .admonition.warn,.md .admonition.warning{border-left:2.5rem solid rgba(255,145,0,.4);background-color:rgba(255,145,0,.15)}.md .admonition.warn::before,.md .admonition.warning::before{content:"\26A0";font-weight:bold;font-size:150%;position:relative;top:2px;color:rgba(128,73,0,.8);left:-2.95rem;display:block;width:0;height:0}.md .admonition.warn>.admonition-title,.md .admonition.warning>.admonition-title{border-color:rgba(255,145,0,.4)}.md .admonition.error{border-left: 2.5rem solid rgba(255,23,68,.4);background-color:rgba(255,23,68,.15)}.md .admonition.error>.admonition-title{border-color:rgba(255,23,68,.4)}.md .admonition.error::before{content: "\2612";font-family:"Arial";font-size:200%;position:relative;color:rgba(128,12,34,.8);top:-2px;left:-3rem;display:block;width:0;height:0}.md .admonition p:last-child{margin-bottom:0}.md li.checked,.md li.unchecked{list-style:none;overflow:visible;text-indent:-1.2em}.md li.checked:before,.md li.unchecked:before{content:"\2611";display:block;float:left;width:1em;font-size:120%}.md li.unchecked:before{content:"\2610"}</style><style>.md h1::before {
content:counter(h1) " ";
counter-increment: h1;margin-right:10px}

.md h2::before {
content:counter(h1) "."counter(h2) " ";
counter-increment: h2;margin-right:10px}

.md h3::before {
content:counter(h1) "."counter(h2) "."counter(h3) " ";
counter-increment: h3;margin-right:10px}

.md h4::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) " ";
counter-increment: h4;margin-right:10px}

.md h5::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) "."counter(h5) " ";
counter-increment: h5;margin-right:10px}

.md h6::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) "."counter(h5) "."counter(h6) " ";
counter-increment: h6;margin-right:10px}

</style><style>.hljs{display:block;overflow-x:auto;padding:0.5em;background:#fff;color:#000;-webkit-text-size-adjust:none}.hljs-comment{color:#006a00}.hljs-keyword{color:#02E}.hljs-literal,.nginx .hljs-title{color:#aa0d91}.method,.hljs-list .hljs-title,.hljs-tag .hljs-title,.setting .hljs-value,.hljs-winutils,.tex .hljs-command,.http .hljs-title,.hljs-request,.hljs-status,.hljs-name{color:#008}.hljs-envvar,.tex .hljs-special{color:#660}.hljs-string{color:#c41a16}.hljs-tag .hljs-value,.hljs-cdata,.hljs-filter .hljs-argument,.hljs-attr_selector,.apache .hljs-cbracket,.hljs-date,.hljs-regexp{color:#080}.hljs-sub .hljs-identifier,.hljs-pi,.hljs-tag,.hljs-tag .hljs-keyword,.hljs-decorator,.ini .hljs-title,.hljs-shebang,.hljs-prompt,.hljs-hexcolor,.hljs-rule .hljs-value,.hljs-symbol,.hljs-symbol .hljs-string,.hljs-number,.css .hljs-function,.hljs-function .hljs-title,.coffeescript .hljs-attribute{color:#A0C}.hljs-function .hljs-title{font-weight:bold;color:#000}.hljs-class .hljs-title,.smalltalk .hljs-class,.hljs-type,.hljs-typename,.hljs-tag .hljs-attribute,.hljs-doctype,.hljs-class .hljs-id,.hljs-built_in,.setting,.hljs-params,.clojure .hljs-attribute{color:#5c2699}.hljs-variable{color:#3f6e74}.css .hljs-tag,.hljs-rule .hljs-property,.hljs-pseudo,.hljs-subst{color:#000}.css .hljs-class,.css .hljs-id{color:#9b703f}.hljs-value .hljs-important{color:#ff7700;font-weight:bold}.hljs-rule .hljs-keyword{color:#c5af75}.hljs-annotation,.apache .hljs-sqbracket,.nginx .hljs-built_in{color:#9b859d}.hljs-preprocessor,.hljs-preprocessor *,.hljs-pragma{color:#643820}.tex .hljs-formula{background-color:#eee;font-style:italic}.diff .hljs-header,.hljs-chunk{color:#808080;font-weight:bold}.diff .hljs-change{background-color:#bccff9}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-comment .hljs-doctag{font-weight:bold}.method .hljs-id{color:#000}</style><style>div.title { padding-top: 40px; } div.afterTitles { height: 15px; }</style><meta charset="utf-8" emacsmode="-*- markdown -*-">
                            <span class="md"><p><title>A warm welcome to DNS</title></p><div class="title"> A warm welcome to DNS </div>

<div class="afterTitles"></div>

<p></p><p>

Note: this page is part of the
'<a href="/">hello-dns</a>' documentation effort.

</p>
<div class="longTOC"><div class="tocHeader">Contents</div><p><a href="#" class="tocTop">(Top)</a><br>
<a href="#teachingdns" class="level1"><span class="tocNumber">1&nbsp; </span>teaching DNS</a><br>
&nbsp;&nbsp;<a href="#teachingdns/features" class="level2"><span class="tocNumber">1.1&nbsp; </span>Features</a><br>
<a href="#whatmakestdnsdifferent?" class="level1"><span class="tocNumber">2&nbsp; </span>What makes <code>tdns</code> different?</a><br>
&nbsp;&nbsp;<a href="#whatmakestdnsdifferent?/thatsoundslikehubris" class="level2"><span class="tocNumber">2.1&nbsp; </span>That sounds like hubris</a><br>
<a href="#howdidallthosefeaturesfitin~1500lines?" class="level1"><span class="tocNumber">3&nbsp; </span>How did all those features fit in ~1500 lines?</a><br>
&nbsp;&nbsp;<a href="#howdidallthosefeaturesfitin~1500lines?/thednstree" class="level2"><span class="tocNumber">3.1&nbsp; </span>The DNS Tree</a><br>
&nbsp;&nbsp;<a href="#howdidallthosefeaturesfitin~1500lines?/puttingthetrickybitsatafundamentallevel" class="level2"><span class="tocNumber">3.2&nbsp; </span>Putting the tricky bits at a fundamental level</a><br>
&nbsp;&nbsp;<a href="#howdidallthosefeaturesfitin~1500lines?/theinnersymmetryofdns" class="level2"><span class="tocNumber">3.3&nbsp; </span>The inner symmetry of DNS</a><br>
<a href="#nextsteps" class="level1"><span class="tocNumber">4&nbsp; </span>Next steps</a><br>
</p></div><a class="target" name="teachingdns">&nbsp;</a><a class="target" name="teachingdns">&nbsp;</a><a class="target" name="toc1">&nbsp;</a><h1>teaching DNS</h1>
<p>

Welcome to tdns, a 'from scratch' teaching authoritative server,
implementing all of <a href="/basic.html">basic DNS</a> in
<del>1400</del> <del>1500</del> 1600 lines of code.  Code is
<a href="https://github.com/ahupowerdns/hello-dns/tree/master/tdns">here</a>.  To
compile, see <a href="/tdns/">here</a>.

</p><p>

<code>tdns</code> is part of the '<a href="/">hello-dns</a>' effort
to provide a good entry point into DNS.  This project was started after an
<a href="https://blog.powerdns.com/2018/03/22/the-dns-camel-or-the-rise-in-dns-complexit/">IETF
presentation</a>
by Bert Hubert of PowerDNS in which it was discovered the DNS standards have
now grown to 2500 pages, and we can no longer expect new entrants to the
field to read all that.  After 30 years, DNS deserves a fresh explanation
and <a href="/">hello-dns</a> is it.

</p><p>

Even though the 'hello-dns' documents describe how basic DNS works, and how
an authoritative server should function, nothing quite says how to do things
like actual running code.  <code>tdns</code> is small enough to read in one sitting and
shows how DNS packets are parsed and generated.  <code>tdns</code> is currently written
in C++ 2014, and is MIT licensed.  Reimplementations in other languages are
highly welcome, as these may be more accessible to programmers not fluent in
C++.

</p><p>

The goals of tdns are:

</p><p>

</p><ul>
 <li class="asterisk">Showing the DNS algorithms 'in code'
</li>
 <li class="asterisk">Protocol correctness, except where the protocol needs updating
</li>
 <li class="asterisk">Suitable for educational purposes
</li>
 <li class="asterisk">Display best practices, both in DNS and security
</li>
 <li class="asterisk"><strong class="asterisk">Be a living warning for how hard it is to write a nameserver correctly</strong></li></ul>

<p></p><p>

The target audience of <code>tdns</code> is anyone pondering or actually implementing
an authoritative nameserver or a stub resolver.

</p><p>

Non-goals are:

</p><p>

</p><ul>
 <li class="asterisk">Performance (beyond 100kqps)
</li>
 <li class="asterisk">Implementing more features (unless very educational)
</li>
 <li class="asterisk">DNSSEC (for now)</li></ul>

<p></p><p>

Besides being 'teachable', <code>tdns</code> could actually be useful if you need a
4-file dependency-light library that can look up DNS things for you.

</p>
<a class="target" name="features">&nbsp;</a><a class="target" name="teachingdns/features">&nbsp;</a><a class="target" name="toc1.1">&nbsp;</a><h2>Features</h2>
<p>

Despite being very small, <code>tdns</code> covers a lot of ground, implementing all
parts of 'basic DNS' (as defined by the 'hello-dns' pages):

</p><p>

</p><ul>
 <li class="asterisk">A, AAAA, CNAME, MX, NS, PTR, SOA, NAPTR, SRV, TXT, “Unknown”
</li>
 <li class="asterisk">UDP &amp; TCP
</li>
 <li class="asterisk">Empty non-terminals
</li>
 <li class="asterisk">AXFR (incoming and outgoing)
</li>
 <li class="asterisk">Wildcards
</li>
 <li class="asterisk">Delegations
</li>
 <li class="asterisk">Glue records
</li>
 <li class="asterisk">Truncation
</li>
 <li class="asterisk">Compression / Decompression</li></ul>

<p></p><p>

As a bonus:

</p><p>

</p><ul>
 <li class="asterisk">EDNS (buffer size, flags, extended RCode, no options)</li></ul>

<p></p><p>

What this means is that with <code>tdns</code>, you can actually host your domain name,
or even slave it from another master server.

</p>
<a class="target" name="whatmakestdnsdifferent?">&nbsp;</a><a class="target" name="whatmakestdnsdifferent?">&nbsp;</a><a class="target" name="toc2">&nbsp;</a><h1>What makes <code>tdns</code> different?</h1>
<p>

There is no shortage of nameservers.  In fact, there is an embarrassing
richness of very good ones out there already.  So why bother?  The biggest
problem with DNS today is not the great open source implementations.  It is
the absolutely dreadful stuff we find in appliances, modems, load balancers,
CDNs, CPEs and routers.

</p><p>

The DNS community frequently laments how much work our resolvers have to do
to work around broken implementations.  In fact, we are so fed up with this
that ISC, NLNetLabs, CZNIC and PowerDNS together have announced that
starting 2019 <a href="https://blog.powerdns.com/2018/03/22/removing-edns-workarounds/">we will no longer work around certain classes of
breakage</a>.

</p><p>

In addition, with the advent of RFCs like <a href="https://tools.ietf.org/html/rfc8020">RFC
8020</a> sending incorrect answers will
start wiping out your domain name.

</p><p>

However, we can't put the all (or even most) of the blame for disappointing
quality on the embedded and closed source implementation community.  It was
indeed frighteningly hard to out find how to write a correct authoritative
nameserver.

</p><p>

Existing open source nameservers are all highly optimized and/or have
decades of operational expertise (and trauma) worked into their code.  What
this means is that actually reading that code to learn about DNS is not
easy.  Achieving millions of queries per second does not leave the luxury of
keeping code in an accessible or educational state.

</p><p>

<code>tdns</code> addresses this gap by being a 1500 line long server that is well
documented and commented. Any competent programmer can read the entire
source code a few hours and observe how things really should be done.

</p>
<a class="target" name="thatsoundslikehubris">&nbsp;</a><a class="target" name="whatmakestdnsdifferent?/thatsoundslikehubris">&nbsp;</a><a class="target" name="toc2.1">&nbsp;</a><h2>That sounds like hubris</h2>
<p>

In a sense, this is by design. <code>tdns</code> attempts to do everything not only
correctly but also in a best practice fashion. It wants to be an excellent
nameserver that is fully compliant to all relevant standards and lore.

</p><p>

It is hoped that the DNS community will rally to this cause and pore over
the <code>tdns</code> source code to spot everything that could potentially be wrong or
could be done better.

</p><p>

In other words, where <code>tdns</code> is currently not right, we hope that with
sufficient attention it soon will be. Bikeshed away!

</p>
<a class="target" name="howdidallthosefeaturesfitin~1500lines?">&nbsp;</a><a class="target" name="howdidallthosefeaturesfitin~1500lines?">&nbsp;</a><a class="target" name="toc3">&nbsp;</a><h1>How did all those features fit in ~1500 lines?</h1>
<p>

Key to a good DNS implementation is having a faithful DNS storage model,
with the correct kind of objects in them.

</p><p>

Over the decades, many many nameservers have started out with an incorrect
storage model, leading to pain later on with empty non-terminals, case
sensitivity, setting the 'AA' bit on glue (or not) and eventually DNSSEC
ordering problems.

</p><p>

When storing DNS as a tree, as described in <a href="https://tools.ietf.org/html/rfc1034">RFC
1034</a>, a lot of things go right
“automatically”.  When DNS Names are a fundamental type composed out of DNS
Labels with the correct case-insensitive equivalence and identity rules,
lots of problems can never happen.  Tons of conversion mechanics also does
not need to be typed in (or forgotten in some places).

</p><p>

The core of <code>tdns</code> therefore is the tree of nodes as intended in 1034,
containing DNS native objects like <code>DNSLabel</code>s and <code>DNSName</code>s. These get
escaping, case sensitivity and binary correctness right 'automatically'.

</p>
<a class="target" name="thednstree">&nbsp;</a><a class="target" name="howdidallthosefeaturesfitin~1500lines?/thednstree">&nbsp;</a><a class="target" name="toc3.1">&nbsp;</a><h2>The DNS Tree</h2>
<p>

Of specific note is the DNS Tree as described in RFC 1034.  Because DNS is
never shown to us as a tree, and in fact is usually presented as a flat
'zone file', it is easy to ignore the tree-like nature of DNS.

</p><p>

<a class="target" name="figure_diagram">&nbsp;</a><svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="304" width="768" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 136,192 L 136,224 " style="fill:none;"></path>
<path d="M 208,192 L 208,224 " style="fill:none;"></path>
<path d="M 296,48 L 296,80 " style="fill:none;"></path>
<path d="M 296,112 L 296,160 " style="fill:none;"></path>
<path d="M 288,16 L 304,16 " style="fill:none;"></path>
<path d="M 192,32 L 272,32 " style="fill:none;"></path>
<path d="M 320,32 L 392,32 " style="fill:none;"></path>
<path d="M 288,48 L 304,48 " style="fill:none;"></path>
<path d="M 160,80 L 176,80 " style="fill:none;"></path>
<path d="M 288,80 L 304,80 " style="fill:none;"></path>
<path d="M 408,80 L 424,80 " style="fill:none;"></path>
<path d="M 160,112 L 176,112 " style="fill:none;"></path>
<path d="M 288,112 L 304,112 " style="fill:none;"></path>
<path d="M 408,112 L 424,112 " style="fill:none;"></path>
<path d="M 128,160 L 144,160 " style="fill:none;"></path>
<path d="M 200,160 L 216,160 " style="fill:none;"></path>
<path d="M 288,160 L 304,160 " style="fill:none;"></path>
<path d="M 128,192 L 144,192 " style="fill:none;"></path>
<path d="M 200,192 L 216,192 " style="fill:none;"></path>
<path d="M 288,192 L 304,192 " style="fill:none;"></path>
<path d="M 128,224 L 144,224 " style="fill:none;"></path>
<path d="M 200,224 L 216,224 " style="fill:none;"></path>
<path d="M 128,256 L 144,256 " style="fill:none;"></path>
<path d="M 200,256 L 216,256 " style="fill:none;"></path>
<path d="M 168,112 L 192,160 " style="fill:none;"></path>
<path d="M 392,32 L 416,80 " style="fill:none;"></path>
<path d="M 168,80 L 192,32 " style="fill:none;"></path>
<path d="M 144,160 L 168,112 " style="fill:none;"></path>
<path d="M 288,16 C 271.2,16 272,32 272,32 " style="fill:none;"></path>
<path d="M 304,16 C 320.8,16 320,32 320,32 " style="fill:none;"></path>
<path d="M 288,48 C 271.2,48 272,32 272,32 " style="fill:none;"></path>
<path d="M 304,48 C 320.8,48 320,32 320,32 " style="fill:none;"></path>
<path d="M 160,80 C 143.2,80 144,96 144,96 " style="fill:none;"></path>
<path d="M 176,80 C 192.8,80 192,96 192,96 " style="fill:none;"></path>
<path d="M 288,80 C 271.2,80 272,96 272,96 " style="fill:none;"></path>
<path d="M 304,80 C 320.8,80 320,96 320,96 " style="fill:none;"></path>
<path d="M 408,80 C 391.2,80 392,96 392,96 " style="fill:none;"></path>
<path d="M 424,80 C 440.8,80 440,96 440,96 " style="fill:none;"></path>
<path d="M 160,112 C 143.2,112 144,96 144,96 " style="fill:none;"></path>
<path d="M 176,112 C 192.8,112 192,96 192,96 " style="fill:none;"></path>
<path d="M 288,112 C 271.2,112 272,96 272,96 " style="fill:none;"></path>
<path d="M 304,112 C 320.8,112 320,96 320,96 " style="fill:none;"></path>
<path d="M 408,112 C 391.2,112 392,96 392,96 " style="fill:none;"></path>
<path d="M 424,112 C 440.8,112 440,96 440,96 " style="fill:none;"></path>
<path d="M 128,160 C 111.2,160 112,176 112,176 " style="fill:none;"></path>
<path d="M 144,160 C 160.8,160 160,176 160,176 " style="fill:none;"></path>
<path d="M 200,160 C 183.2,160 184,176 184,176 " style="fill:none;"></path>
<path d="M 216,160 C 232.8,160 232,176 232,176 " style="fill:none;"></path>
<path d="M 288,160 C 271.2,160 272,176 272,176 " style="fill:none;"></path>
<path d="M 304,160 C 320.8,160 320,176 320,176 " style="fill:none;"></path>
<path d="M 128,192 C 111.2,192 112,176 112,176 " style="fill:none;"></path>
<path d="M 144,192 C 160.8,192 160,176 160,176 " style="fill:none;"></path>
<path d="M 200,192 C 183.2,192 184,176 184,176 " style="fill:none;"></path>
<path d="M 216,192 C 232.8,192 232,176 232,176 " style="fill:none;"></path>
<path d="M 288,192 C 271.2,192 272,176 272,176 " style="fill:none;"></path>
<path d="M 304,192 C 320.8,192 320,176 320,176 " style="fill:none;"></path>
<path d="M 128,224 C 111.2,224 112,240 112,240 " style="fill:none;"></path>
<path d="M 144,224 C 160.8,224 160,240 160,240 " style="fill:none;"></path>
<path d="M 200,224 C 183.2,224 184,240 184,240 " style="fill:none;"></path>
<path d="M 216,224 C 232.8,224 232,240 232,240 " style="fill:none;"></path>
<path d="M 128,256 C 111.2,256 112,240 112,240 " style="fill:none;"></path>
<path d="M 144,256 C 160.8,256 160,240 160,240 " style="fill:none;"></path>
<path d="M 200,256 C 183.2,256 184,240 184,240 " style="fill:none;"></path>
<path d="M 216,256 C 232.8,256 232,240 232,240 " style="fill:none;"></path>
<g transform="translate(0,0)"><text text-anchor="middle" x="24" y="36">1</text><text text-anchor="middle" x="24" y="100">2</text><text text-anchor="middle" x="160" y="100">i</text><text text-anchor="middle" x="168" y="100">e</text><text text-anchor="middle" x="176" y="100">t</text><text text-anchor="middle" x="184" y="100">f</text><text text-anchor="middle" x="288" y="100">i</text><text text-anchor="middle" x="296" y="100">e</text><text text-anchor="middle" x="304" y="100">t</text><text text-anchor="middle" x="312" y="100">g</text><text text-anchor="middle" x="408" y="100">.</text><text text-anchor="middle" x="416" y="100">.</text><text text-anchor="middle" x="424" y="100">.</text><text text-anchor="middle" x="24" y="180">3</text><text text-anchor="middle" x="128" y="180">o</text><text text-anchor="middle" x="136" y="180">r</text><text text-anchor="middle" x="144" y="180">d</text><text text-anchor="middle" x="200" y="180">f</text><text text-anchor="middle" x="208" y="180">r</text><text text-anchor="middle" x="216" y="180">a</text><text text-anchor="middle" x="288" y="180">.</text><text text-anchor="middle" x="296" y="180">.</text><text text-anchor="middle" x="304" y="180">.</text><text text-anchor="middle" x="24" y="244">4</text><text text-anchor="middle" x="128" y="244">n</text><text text-anchor="middle" x="136" y="244">s</text><text text-anchor="middle" x="144" y="244">1</text><text text-anchor="middle" x="200" y="244">n</text><text text-anchor="middle" x="208" y="244">s</text><text text-anchor="middle" x="216" y="244">2</text></g></g></svg></p><center><div class="imagecaption"><b style="font-style:normal;">Figure&nbsp;1:</b> DNS Tree containing data nodes <code>ns1.ord.ietf.org</code>, <code>ns2.fra.ietf.org</code>, <code>ietf.org</code> and <code>org</code> </div></center>

<p></p><p>

To find nodes within the DNS tree, start matching from the top. This zone is
called <code>org</code>, so at depth 4 we can find <code>ns1.ord.ietf.org</code>, after first
matching nodes called <code>ietf</code>, <code>ord</code> and finally <code>ns1</code>.

</p><p>

If this tree is embraced, it turns out that a nameserver can use the very
same tree implementation three times:

</p><p>

</p><ol start="1">
<li class="number">To find the most specific zone to be serving answers from
</li>
<li class="number">To traverse that zone to find the correct answers or delegation
</li>
<li class="number">To implement DNS name compression</li></ol>

<p></p><p>

By reusing the same logic three times, there is less code to type and less
to explain.

</p><p>

Interestingly, when asked (via Paul Vixie), Paul Mockapetris indicated he
was surprised that the DNS Tree could in fact be reused for DNS name
compression. This 2018 discovery in a 1985 protocol turns out to work
surprisingly well!

</p>
<a class="target" name="puttingthetrickybitsatafundamentallevel">&nbsp;</a><a class="target" name="howdidallthosefeaturesfitin~1500lines?/puttingthetrickybitsatafundamentallevel">&nbsp;</a><a class="target" name="toc3.2">&nbsp;</a><h2>Putting the tricky bits at a fundamental level</h2>
<p>

DNS names look surprisingly like text strings, but they very much are not.
For starters, DNS is case insensitive in its own special way, and such rules
must be obeyed for DNSSEC to ever work.

</p><p>

Furthermore, despite appearances, DNS is 8-bit safe. This means that
individual DNS labels (usually separated by dots) can contain embedded 0
characters, but also actual dots themselves.

</p><p>

A lot of code 'up the stack' can be simplified by having basic types that
are fully DNS native, like DNS Labels which are case insensitive, stored in
binary and length limited by themselves.

</p><p>

Code that uses “strings” for DNS may struggle to recognize (in all places!)
that <code>www.PowerDNS.COM</code>, <code>www.powerdns.com</code>, <code>www.p\079werdns.com.</code> and
<code>www.p\111werdns.com</code> are all equivalent, but that <code>www\046powerdns.com</code> is
not.

</p>
<a class="target" name="theinnersymmetryofdns">&nbsp;</a><a class="target" name="howdidallthosefeaturesfitin~1500lines?/theinnersymmetryofdns">&nbsp;</a><a class="target" name="toc3.3">&nbsp;</a><h2>The inner symmetry of DNS</h2>
<p>

In what is likely not an accident, all known DNS record types are laid out
exactly the same in the packet as in the zone file. So in other words the
well known SOA record looks like this on our screen:

</p><pre class="listing backtick"><code><span class="line"></span>ripe.net. SOA	manus.authdns.ripe.net. dns.ripe.net. <span class="hljs-number">1523965801</span> <span class="hljs-number">3600</span> <span class="hljs-number">600</span> <span class="hljs-number">864000</span> <span class="hljs-number">300</span>
<span class="line"></span>#                      mname               rname         serial  ref  ret  <span class="hljs-built_in">exp</span>   <span class="hljs-built_in">min</span></code></pre><p>

And in the packet, this very same record looks like this:

</p><p>

<svg class="diagram" xmlns="http://www.w3.org/2000/svg" version="1.1" height="256" width="464" style="margin:0 auto 0 auto;"><g transform="translate(8,16 )">
<path d="M 32,64 L 32,224 " style="fill:none;"></path>
<path d="M 416,64 L 416,224 " style="fill:none;"></path>
<path d="M 32,0 L 416,0 " style="fill:none;"></path>
<path d="M 32,32 L 416,32 " style="fill:none;"></path>
<path d="M 32,64 L 416,64 " style="fill:none;"></path>
<path d="M 32,96 L 416,96 " style="fill:none;"></path>
<path d="M 32,128 L 416,128 " style="fill:none;"></path>
<path d="M 32,160 L 416,160 " style="fill:none;"></path>
<path d="M 32,192 L 416,192 " style="fill:none;"></path>
<path d="M 32,224 L 416,224 " style="fill:none;"></path>
<g transform="translate(0,0)"><text text-anchor="middle" x="32" y="20">/</text><text text-anchor="middle" x="208" y="20">M</text><text text-anchor="middle" x="216" y="20">N</text><text text-anchor="middle" x="224" y="20">A</text><text text-anchor="middle" x="232" y="20">M</text><text text-anchor="middle" x="240" y="20">E</text><text text-anchor="middle" x="416" y="20">/</text><text text-anchor="middle" x="32" y="52">/</text><text text-anchor="middle" x="208" y="52">R</text><text text-anchor="middle" x="216" y="52">N</text><text text-anchor="middle" x="224" y="52">A</text><text text-anchor="middle" x="232" y="52">M</text><text text-anchor="middle" x="240" y="52">E</text><text text-anchor="middle" x="416" y="52">/</text><text text-anchor="middle" x="200" y="84">S</text><text text-anchor="middle" x="208" y="84">E</text><text text-anchor="middle" x="216" y="84">R</text><text text-anchor="middle" x="224" y="84">I</text><text text-anchor="middle" x="232" y="84">A</text><text text-anchor="middle" x="240" y="84">L</text><text text-anchor="middle" x="200" y="116">R</text><text text-anchor="middle" x="208" y="116">E</text><text text-anchor="middle" x="216" y="116">F</text><text text-anchor="middle" x="224" y="116">R</text><text text-anchor="middle" x="232" y="116">E</text><text text-anchor="middle" x="240" y="116">S</text><text text-anchor="middle" x="248" y="116">H</text><text text-anchor="middle" x="208" y="148">R</text><text text-anchor="middle" x="216" y="148">E</text><text text-anchor="middle" x="224" y="148">T</text><text text-anchor="middle" x="232" y="148">R</text><text text-anchor="middle" x="240" y="148">Y</text><text text-anchor="middle" x="200" y="180">E</text><text text-anchor="middle" x="208" y="180">X</text><text text-anchor="middle" x="216" y="180">P</text><text text-anchor="middle" x="224" y="180">I</text><text text-anchor="middle" x="232" y="180">R</text><text text-anchor="middle" x="240" y="180">E</text><text text-anchor="middle" x="200" y="212">M</text><text text-anchor="middle" x="208" y="212">I</text><text text-anchor="middle" x="216" y="212">N</text><text text-anchor="middle" x="224" y="212">I</text><text text-anchor="middle" x="232" y="212">M</text><text text-anchor="middle" x="240" y="212">U</text><text text-anchor="middle" x="248" y="212">M</text></g></g></svg>

</p><p>

DNS Records need to be: 1) parsed from a message 2) serialized to a message
3) parsed from zone file format 4) emitted in zone file format.

</p><p>

It turns out these four conversions exhibit complete symmetry for all
regular DNS resource types.

</p><p>

This means we can define one conversion 'operator':

</p><pre class="listing backtick"><code><span class="line"></span><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SOAGen::doConv</span><span class="hljs-params">(<span class="hljs-keyword">auto</span>&amp; x)</span>
<span class="line"></span></span>{
<span class="line"></span>  x.<span class="hljs-built_in">xfrName</span>(d_mname);     x.<span class="hljs-built_in">xfrName</span>(d_rname);
<span class="line"></span>  x.<span class="hljs-built_in">xfrUInt32</span>(d_serial);  x.<span class="hljs-built_in">xfrUInt32</span>(d_refresh);
<span class="line"></span>  x.<span class="hljs-built_in">xfrUInt32</span>(d_retry);   x.<span class="hljs-built_in">xfrUInt32</span>(d_expire);
<span class="line"></span>  x.<span class="hljs-built_in">xfrUInt32</span>(d_minimum);
<span class="line"></span>}</code></pre><p>

And actually reuse that for all four cases:

</p><pre class="listing backtick"><code><span class="line"></span>SOAGen::<span class="hljs-built_in">SOAGen</span>(DNSMessageReader&amp; dmr)         { doConv(dmr); }
<span class="line"></span>void SOAGen::<span class="hljs-built_in">toMessage</span>(DNSMessageWriter&amp; dmw) { doConv(dmw); }
<span class="line"></span>SOAGen::<span class="hljs-built_in">SOAGen</span>(StringReader&amp; sr)              { doConv(sr);  }
<span class="line"></span>
<span class="line"></span>std::string SOAGen::<span class="hljs-built_in">toString</span>()
<span class="line"></span>{
<span class="line"></span>  StringBuilder sb;
<span class="line"></span>  doConv(sb);
<span class="line"></span>  return sb<span class="hljs-selector-class">.d_string</span>;
<span class="line"></span>}
<span class="line"></span></code></pre><p>

Exploiting this symmetry does not only save a lot of typing, it also saves
us from potential inconsistencies.

</p>
<a class="target" name="nextsteps">&nbsp;</a><a class="target" name="nextsteps">&nbsp;</a><a class="target" name="toc4">&nbsp;</a><h1>Next steps</h1>
<p>

It is the hope that <code>tdns</code> is educational and will lead to a better
understanding of DNS. <code>tdns</code> is not yet done and we anxiously await comments
from the rest of the DNS community, as well as reimplementations in other
languages (like Go and Rust).

</p><p>

<code>tdns</code> is described more fully in its
<a href="/tdns/">README</a>.  In addition,
the code is richly commented with Doxygen annotations, which can be seen
<a href="https://powerdns.org/hello-dns/tdns/codedocs/html/">here</a>.  The code itself
meanwhile is on <a href="https://github.com/ahuPowerDNS/hello-dns">GitHub</a>

</p><p>

<script>
window.markdeepOptions={};
window.markdeepOptions.tocStyle = &ldquo;long&rdquo;;
</script>
</p></span><div id="mdContextMenu" style="visibility:hidden"></div><div class="markdeepFooter"><i>formatted by <a href="https://casual-effects.com/markdeep" style="color:#999">Markdeep&nbsp;1.16&nbsp;&nbsp;</a></i><div style="display:inline-block;font-size:13px;font-family:'Times New Roman',serif;vertical-align:middle;transform:translate(-3px,-1px)rotate(135deg);">✒</div></div></body></html>
