<html><head><meta charset="utf-8" emacsmode="-*- markdown -*-">
                            </head><body id="md" style="visibility: visible;"><meta charset="UTF-8"><meta http-equiv="content-type" content="text/html;charset=UTF-8"><meta name="viewport" content="width=600, initial-scale=1"><style>body{max-width:680px;margin:auto;padding:20px;text-align:justify;line-height:140%;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-smoothing:antialiased;color:#222;font-family:Palatino,Georgia,"Times New Roman",serif}</style><style>@media print{*{-webkit-print-color-adjust:exact;text-shadow:none !important}}body{counter-reset: h1 paragraph line item list-item}@page{margin:0;size:auto}#mdContextMenu{position:absolute;background:#383838;cursor:default;border:1px solid #999;color:#fff;padding:4px 0px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,"Helvetica Neue",sans-serif;font-size:85%;font-weight:600;border-radius:4px;box-shadow:0px 3px 10px rgba(0,0,0,35%)}#mdContextMenu div{padding:0px 20px}#mdContextMenu div:hover{background:#1659d1}.md code,.md pre{font-family:Menlo,Consolas,monospace;font-size:85%;text-align:left;line-height:140%}.md .mediumToc code,.md longToc code,.md .shortToc code,.md h1 code,.md h2 code,.md h3 code,.md h4 code,.md h5 code,.md h6 code{font-size:unset}.md div.title{font-size:26px;font-weight:800;line-height:120%;text-align:center}.md div.afterTitles{height:10px}.md div.subtitle{text-align:center}.md iframe.textinsert, .md object.textinsert,.md iframe:not(.markdeep){display:block;margin-top:10px;margin-bottom:10px;width:100%;height:75vh;border:1px solid #000;border-radius:4px;background:#f5f5f4}.md .image{display:inline-block}.md img{max-width:100%;page-break-inside:avoid}.md li{text-align:left;text-indent:0}.md pre.listing {width:100%;tab-size:4;-moz-tab-size:4;-o-tab-size:4;counter-reset:line;overflow-x:auto;resize:horizontal}.md pre.listing .linenumbers span.line:before{width:30px;margin-left:-28px;font-size:80%;text-align:right;counter-increment:line;content:counter(line);display:inline-block;padding-right:13px;margin-right:8px;color:#ccc}.md div.tilde{margin:20px 0 -10px;text-align:center}.md .imagecaption,.md .tablecaption,.md .listingcaption{display:inline-block;margin:7px 5px 12px;text-align:justify;font-style:italic}.md img.pixel{image-rendering:-moz-crisp-edges;image-rendering:pixelated}.md blockquote.fancyquote{margin:25px 0 25px;text-align:left;line-height:160%}.md blockquote.fancyquote::before{content:"“";color:#DDD;font-family:Times New Roman;font-size:45px;line-height:0;margin-right:6px;vertical-align:-0.3em}.md span.fancyquote{font-size:118%;color:#777;font-style:italic}.md span.fancyquote::after{content:"”";font-style:normal;color:#DDD;font-family:Times New Roman;font-size:45px;line-height:0;margin-left:6px;vertical-align:-0.3em}.md blockquote.fancyquote .author{width:100%;margin-top:10px;display:inline-block;text-align:right}.md small{font-size:60%}.md big{font-size:150%}.md div.title,.md contents,.md .tocHeader,.md h1,.md h2,.md h3,.md h4,.md h5,.md h6,.md .shortTOC,.md .mediumTOC,.md .nonumberh1,.md .nonumberh2,.md .nonumberh3,.md .nonumberh4,.md .nonumberh5,.md .nonumberh6{font-family:Verdana,Helvetica,Arial,sans-serif;margin:13.4px 0 13.4px;padding:15px 0 3px;border-top:none;clear:both}.md .tocTop {display:none}.md h1,.md h2,.md h3,.md h4,.md h5,.md h6,.md .nonumberh1,.md .nonumberh2,.md .nonumberh3,.md .nonumberh4,.md .nonumberh5,.md .nonumberh6{page-break-after:avoid;break-after:avoid}.md svg.diagram{display:block;font-family:Menlo,Consolas,monospace;font-size:85%;text-align:center;stroke-linecap:round;stroke-width:2px;page-break-inside:avoid;stroke:#000;fill:#000}.md svg.diagram .opendot{fill:#fff}.md svg.diagram .shadeddot{fill:#CCC}.md svg.diagram .dotteddot{stroke:#000;stroke-dasharray:4;fill:none}.md svg.diagram text{stroke:none}@media print{@page{margin:1in 5mm;transform: scale(150%)}}@media print{.md .pagebreak{page-break-after:always;visibility:hidden}}.md a{font-family:Georgia,Palatino,'Times New Roman'}.md h1,.md .tocHeader,.md .nonumberh1{border-bottom:3px solid;font-size:20px;font-weight:bold;}.md h1,.md .nonumberh1{counter-reset:h2 h3 h4 h5 h6}.md h2,.md .nonumberh2{counter-reset:h3 h4 h5 h6;border-bottom:2px solid #999;color:#555;font-weight:bold;font-size:18px;}.md h3,.md h4,.md h5,.md h6,.md .nonumberh3,.md .nonumberh4,.md .nonumberh5,.md .nonumberh6{font-family:Verdana,Helvetica,Arial,sans-serif;color:#555;font-size:16px;}.md h3{counter-reset:h4 h5 h6}.md h4{counter-reset:h5 h6}.md h5{counter-reset:h6}.md div.table{margin:16px 0 16px 0}.md table{border-collapse:collapse;line-height:140%;page-break-inside:avoid}.md table.table{margin:auto}.md table.calendar{width:100%;margin:auto;font-size:11px;font-family:Verdana,Helvetica,Arial,sans-serif}.md table.calendar th{font-size:16px}.md .today{background:#ECF8FA}.md .calendar .parenthesized{color:#999;font-style:italic}.md table.table th{color:#FFF;background-color:#AAA;border:1px solid #888;padding:8px 15px 8px 15px}.md table.table td{padding:5px 15px 5px 15px;border:1px solid #888}.md table.table tr:nth-child(even){background:#EEE}.md pre.tilde{border-top: 1px solid #CCC;border-bottom: 1px solid #CCC;padding: 5px 0 5px 20px;margin:0 0 0 0;background:#FCFCFC;page-break-inside:avoid}.md a.target{width:0px;height:0px;visibility:hidden;font-size:0px;display:inline-block}.md a:link, .md a:visited{color:#38A;text-decoration:none}.md a:link:hover{text-decoration:underline}.md dt{font-weight:700}.md dl>dd{margin-top:-8px; margin-bottom:8px}.md dl>table{margin:35px 0 30px}.md code{page-break-inside:avoid;} @media print{.md .listing code{white-space:pre-wrap}}.md .endnote{font-size:13px;line-height:15px;padding-left:10px;text-indent:-10px}.md .bib{padding-left:80px;text-indent:-80px;text-align:left}.markdeepFooter{font-size:9px;text-align:right;padding-top:80px;color:#999}.md .mediumTOC{float:right;font-size:12px;line-height:15px;border-left:1px solid #CCC;padding-left:15px;margin:15px 0px 15px 25px}.md .mediumTOC .level1{font-weight:600}.md .longTOC .level1{font-weight:600;display:block;padding-top:12px;margin:0 0 -20px}.md .shortTOC{text-align:center;font-weight:bold;margin-top:15px;font-size:14px}.md .img-attrib-container .img-attrib{font-size:50%;line-height:120%;writing-mode:vertical-rl;position:absolute;bottom:0;right:0;padding:8px 4px;color:#FFF;background-color:rgba(0,0,0,.3)}.md .img-attrib-container .img-attrib a{color:#FFF;text-decoration:none}.md .admonition{position:relative;margin:1em 0;padding:.4rem 1rem;border-radius:.2rem;border-left:2.5rem solid rgba(68,138,255,.4);background-color:rgba(68,138,255,.15);}.md .admonition-title{font-weight:bold;border-bottom:solid 1px rgba(68,138,255,.4);padding-bottom:4px;margin-bottom:4px;margin-left: -1rem;padding-left:1rem;margin-right:-1rem;border-color:rgba(68,138,255,.4)}.md .admonition.tip{border-left:2.5rem solid rgba(50,255,90,.4);background-color:rgba(50,255,90,.15)}.md .admonition.tip::before{content:"\24d8";font-weight:bold;font-size:150%;position:relative;top:3px;color:rgba(26,128,46,.8);left:-2.95rem;display:block;width:0;height:0}.md .admonition.tip>.admonition-title{border-color:rgba(50,255,90,.4)}.md .admonition.warn,.md .admonition.warning{border-left:2.5rem solid rgba(255,145,0,.4);background-color:rgba(255,145,0,.15)}.md .admonition.warn::before,.md .admonition.warning::before{content:"\26A0";font-weight:bold;font-size:150%;position:relative;top:2px;color:rgba(128,73,0,.8);left:-2.95rem;display:block;width:0;height:0}.md .admonition.warn>.admonition-title,.md .admonition.warning>.admonition-title{border-color:rgba(255,145,0,.4)}.md .admonition.error{border-left: 2.5rem solid rgba(255,23,68,.4);background-color:rgba(255,23,68,.15)}.md .admonition.error>.admonition-title{border-color:rgba(255,23,68,.4)}.md .admonition.error::before{content: "\2612";font-family:"Arial";font-size:200%;position:relative;color:rgba(128,12,34,.8);top:-2px;left:-3rem;display:block;width:0;height:0}.md .admonition p:last-child{margin-bottom:0}.md li.checked,.md li.unchecked{list-style:none;overflow:visible;text-indent:-1.2em}.md li.checked:before,.md li.unchecked:before{content:"\2611";display:block;float:left;width:1em;font-size:120%}.md li.unchecked:before{content:"\2610"}</style><style>.md h1::before {
content:counter(h1) " ";
counter-increment: h1;margin-right:10px}

.md h2::before {
content:counter(h1) "."counter(h2) " ";
counter-increment: h2;margin-right:10px}

.md h3::before {
content:counter(h1) "."counter(h2) "."counter(h3) " ";
counter-increment: h3;margin-right:10px}

.md h4::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) " ";
counter-increment: h4;margin-right:10px}

.md h5::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) "."counter(h5) " ";
counter-increment: h5;margin-right:10px}

.md h6::before {
content:counter(h1) "."counter(h2) "."counter(h3) "."counter(h4) "."counter(h5) "."counter(h6) " ";
counter-increment: h6;margin-right:10px}

</style><style>.hljs{display:block;overflow-x:auto;padding:0.5em;background:#fff;color:#000;-webkit-text-size-adjust:none}.hljs-comment{color:#006a00}.hljs-keyword{color:#02E}.hljs-literal,.nginx .hljs-title{color:#aa0d91}.method,.hljs-list .hljs-title,.hljs-tag .hljs-title,.setting .hljs-value,.hljs-winutils,.tex .hljs-command,.http .hljs-title,.hljs-request,.hljs-status,.hljs-name{color:#008}.hljs-envvar,.tex .hljs-special{color:#660}.hljs-string{color:#c41a16}.hljs-tag .hljs-value,.hljs-cdata,.hljs-filter .hljs-argument,.hljs-attr_selector,.apache .hljs-cbracket,.hljs-date,.hljs-regexp{color:#080}.hljs-sub .hljs-identifier,.hljs-pi,.hljs-tag,.hljs-tag .hljs-keyword,.hljs-decorator,.ini .hljs-title,.hljs-shebang,.hljs-prompt,.hljs-hexcolor,.hljs-rule .hljs-value,.hljs-symbol,.hljs-symbol .hljs-string,.hljs-number,.css .hljs-function,.hljs-function .hljs-title,.coffeescript .hljs-attribute{color:#A0C}.hljs-function .hljs-title{font-weight:bold;color:#000}.hljs-class .hljs-title,.smalltalk .hljs-class,.hljs-type,.hljs-typename,.hljs-tag .hljs-attribute,.hljs-doctype,.hljs-class .hljs-id,.hljs-built_in,.setting,.hljs-params,.clojure .hljs-attribute{color:#5c2699}.hljs-variable{color:#3f6e74}.css .hljs-tag,.hljs-rule .hljs-property,.hljs-pseudo,.hljs-subst{color:#000}.css .hljs-class,.css .hljs-id{color:#9b703f}.hljs-value .hljs-important{color:#ff7700;font-weight:bold}.hljs-rule .hljs-keyword{color:#c5af75}.hljs-annotation,.apache .hljs-sqbracket,.nginx .hljs-built_in{color:#9b859d}.hljs-preprocessor,.hljs-preprocessor *,.hljs-pragma{color:#643820}.tex .hljs-formula{background-color:#eee;font-style:italic}.diff .hljs-header,.hljs-chunk{color:#808080;font-weight:bold}.diff .hljs-change{background-color:#bccff9}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-comment .hljs-doctag{font-weight:bold}.method .hljs-id{color:#000}</style><style>div.title { padding-top: 40px; } div.afterTitles { height: 15px; }</style><meta charset="utf-8" emacsmode="-*- markdown -*-">
                            <span class="md"><p><title>A warm welcome to DNS</title></p><div class="title"> A warm welcome to DNS </div>

<div class="afterTitles"></div>

<p></p><p>

Note: this page is part of the
'<a href="/">hello-dns</a>' documentation effort.

</p>
<div class="longTOC"><div class="tocHeader">Contents</div><p><a href="#" class="tocTop">(Top)</a><br>
<a href="#teachingdns:library,authoritative,resolver" class="level1"><span class="tocNumber">1&nbsp; </span>teaching DNS: Library, Authoritative, Resolver</a><br>
<a href="#objectsintdns" class="level1"><span class="tocNumber">2&nbsp; </span>Objects in <code>tdns</code></a><br>
&nbsp;&nbsp;<a href="#objectsintdns/dnslabel" class="level2"><span class="tocNumber">2.1&nbsp; </span>DNSLabel</a><br>
&nbsp;&nbsp;<a href="#objectsintdns/dnsname" class="level2"><span class="tocNumber">2.2&nbsp; </span>DNSName</a><br>
&nbsp;&nbsp;<a href="#objectsintdns/dnstype,rcode,dnssection" class="level2"><span class="tocNumber">2.3&nbsp; </span>DNSType, RCode, DNSSection</a><br>
&nbsp;&nbsp;<a href="#objectsintdns/tdig" class="level2"><span class="tocNumber">2.4&nbsp; </span><code>tdig</code></a><br>
<a href="#parsingandgeneratingdnsmessages" class="level1"><span class="tocNumber">3&nbsp; </span>Parsing and generating DNS Messages</a><br>
&nbsp;&nbsp;<a href="#parsingandgeneratingdnsmessages/rrgens:dealingwithalltherecordtypes" class="level2"><span class="tocNumber">3.1&nbsp; </span><code>RRGen</code>s: dealing with all the record types</a><br>
&nbsp;&nbsp;<a href="#parsingandgeneratingdnsmessages/dnsmessagereader" class="level2"><span class="tocNumber">3.2&nbsp; </span>DNSMessageReader</a><br>
&nbsp;&nbsp;<a href="#parsingandgeneratingdnsmessages/dnsmessagewriter" class="level2"><span class="tocNumber">3.3&nbsp; </span>DNSMessageWriter</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#parsingandgeneratingdnsmessages/dnsmessagewriter/compression" class="level3"><span class="tocNumber">3.3.1&nbsp; </span>Compression</a><br>
&nbsp;&nbsp;<a href="#parsingandgeneratingdnsmessages/ednsandtruncation" class="level2"><span class="tocNumber">3.4&nbsp; </span>EDNS and truncation</a><br>
<a href="#internals" class="level1"><span class="tocNumber">4&nbsp; </span>Internals</a><br>
<a href="#compilingandrunningtdns" class="level1"><span class="tocNumber">5&nbsp; </span>Compiling and running tdns</a><br>
</p></div><a class="target" name="teachingdns:library,authoritative,resolver">&nbsp;</a><a class="target" name="teachingdns:library,authoritative,resolver">&nbsp;</a><a class="target" name="toc1">&nbsp;</a><h1>teaching DNS: Library, Authoritative, Resolver</h1>
<p>

Welcome to tdns, a 'from scratch' teaching DNS library.  Based on <code>tdns</code>,
<a href="tauth.html"><code>tauth</code></a> and <a href="tres.html"><code>tres</code></a> implement all of <a href="../basic.html">basic
DNS</a> and large parts of DNSSEC in <del>2000</del> <del>3000</del> 3100
lines of code.  Code is
<a href="https://github.com/ahupowerdns/hello-dns/tree/master/tdns">here</a>.  To
compile, see the end of this document.

</p><p>

Even though the 'hello-dns' documents describe how basic DNS works, and how
servers should function, nothing quite says how to do things
like actual running code.  <code>tdns</code> is small enough to read in one sitting and
shows how DNS packets are parsed and generated.  <code>tdns</code> is currently written
in C++ 2014, and is MIT licensed.  Reimplementations in other languages are
highly welcome, as these may be more accessible to other programmers.

</p><p>

Please contact <a href="mailto:bert.hubert@powerdns.com">bert.hubert@powerdns.com</a> or
<a href="https://twitter.com/PowerDNS_Bert">@PowerDNS_Bert</a> if you have plans or
feedback.

</p><p>

The goals of <code>tdns</code>, <code>tauth</code> &amp; <code>tres</code> are:

</p><p>

</p><ul>
 <li class="asterisk">Showing the DNS algorithms 'in code'
</li>
 <li class="asterisk">Protocol correctness, except where the protocol needs updating
</li>
 <li class="asterisk">Suitable for educational purposes
</li>
 <li class="asterisk">Display best practices, both in DNS and security
</li>
 <li class="asterisk"><strong class="asterisk">Be a living warning for how hard it is to write a nameserver correctly</strong></li></ul>

<p></p><p>

Non-goals are:

</p><p>

</p><ul>
 <li class="asterisk">Performance
</li>
 <li class="asterisk">Implementing more features (unless very educational)
</li>
 <li class="asterisk">DNSSEC signing, validation</li></ul>

<p></p><p>

A more narrative explanation of what <code>tdns</code> is and what we hope it will
achieve can be found <a href="intro.html">here</a>.

</p><p>

The code for <code>tdns</code> can be found on <a href="https://github.com/ahupowerdns/hello-dns/blob/master/tdns/">GitHub</a> and is also documented
using <a href="codedocs/html">Doxygen</a>.

</p>
<a class="target" name="objectsintdns">&nbsp;</a><a class="target" name="objectsintdns">&nbsp;</a><a class="target" name="toc2">&nbsp;</a><h1>Objects in <code>tdns</code></h1>
<p>

These are found in <a href="dns-storage.hh">dns-storage.hh</a>
and
<a href="dns-storage.hh">dns-storage.cc</a>.

</p>
<a class="target" name="dnslabel">&nbsp;</a><a class="target" name="objectsintdns/dnslabel">&nbsp;</a><a class="target" name="toc2.1">&nbsp;</a><h2>DNSLabel</h2>
<p>

The most basic object in <code>tdns</code> is DNSLabel. <code>www.powerdns.com</code> consists of
three labels, <code>www</code>, <code>powerdns</code> and <code>com</code>. DNS is fundamentally case
insensitive (in its own unique way), and so is DNSLabel. So for example:

</p><pre class="listing backtick"><code><span class="line"></span>	<span class="hljs-function">DNSLabel <span class="hljs-title">a</span>(<span class="hljs-params"><span class="hljs-string">"www"</span></span>), <span class="hljs-title">b</span>(<span class="hljs-params"><span class="hljs-string">"WWW"</span></span>)</span>;
<span class="line"></span>	<span class="hljs-keyword">if</span>(a==b) cout &lt;&lt; <span class="hljs-string">"The same\n"</span>;</code></pre><p>
Will print 'the same'.

</p><p>

In DNS a label consists of between 1 and 63 characters, and these characters
can be any 8 bit value, including <code>0x0</code>. By making our fundamental data type
<code>DNSLabel</code> behave like this, all the rest of <code>tdns</code> automatically gets all
of this right.

</p><p>

When DNS labels contain spaces or other non-ascii characters, and a label
needs to be converted for screen display or entry, escaping rules apply. The
only place in a nameserver where these escaping rules should be enabled is
in the parsing or printing of DNS Labels.

</p><p>

The input to a <code>DNSLabel</code> is an unescaped binary string. The escaping
example from RFC 4343 thus works like this:

</p><pre class="listing backtick"><code><span class="line"></span>	<span class="hljs-function">DNSLabel <span class="hljs-title">dl</span>(<span class="hljs-params"><span class="hljs-string">"Donald E. Eastlake 3rd"</span></span>)</span>;
<span class="line"></span>	cout &lt;&lt; dl &lt;&lt; endl; <span class="hljs-comment">// prints: Donald\032E\.\032Eastlake\0323rd</span></code></pre>
<a class="target" name="dnsname">&nbsp;</a><a class="target" name="objectsintdns/dnsname">&nbsp;</a><a class="target" name="toc2.2">&nbsp;</a><h2>DNSName</h2>
<p>

A sequence of DNS Labels makes a DNS name. We store such a sequence as a
<code>DNSName</code>. To make this safe, even in the face of embedded dots, spaces and
other things, within <code>tdns</code> we make no effort to parse <code>www.powerdns.com</code> in
the code. Instead, use this:

</p><pre class="listing backtick"><code><span class="line"></span>	DNSName sample({<span class="hljs-string">"www"</span>, <span class="hljs-string">"powerdns"</span>, <span class="hljs-string">"com"</span>});
<span class="line"></span>	cout &lt;&lt; <span class="hljs-string">sample &lt;&lt;"\n"; // prints www.powerdns.com.
<span class="line"></span>
<span class="line"></span>	sample</span>.pop_back();
<span class="line"></span>	cout &lt;&lt; <span class="hljs-string">sample &lt;&lt; ", size: " &lt;&lt; sample</span>.size() &lt;&lt; <span class="hljs-string">sample.size() &lt;&lt; '\n';
<span class="line"></span>	// prints www.powerdns., size 2
<span class="line"></span></span></code></pre><p>

Note: for convenience, when parsing human-generated input, <code>makeDNSName()</code>
is available to make a DNSName from a string.

</p><p>

Since a <code>DNSName</code> consists of <code>DNSLabel</code>s, it gets the same escaping. To
again emphasise how we interpret the input as binary, ponder:

</p><pre class="listing backtick"><code><span class="line"></span>	<span class="hljs-function">DNSName <span class="hljs-title">test</span>(<span class="hljs-params">{<span class="hljs-string">"powerdns"</span>, <span class="hljs-string">"com."</span>}</span>)</span>;
<span class="line"></span>	cout &lt;&lt; test &lt;&lt; endl; <span class="hljs-comment">// prints: powerdns.com\..</span>
<span class="line"></span>
<span class="line"></span>	<span class="hljs-keyword">const</span> <span class="hljs-built_in">char</span> zero[]=<span class="hljs-string">"p\x0werdns"</span>;
<span class="line"></span>	<span class="hljs-function">DNSName <span class="hljs-title">test2</span>(<span class="hljs-params">{std::<span class="hljs-built_in">string</span>(zero, <span class="hljs-keyword">sizeof</span>(zero</span>)-1), "com"})</span>;
<span class="line"></span>
<span class="line"></span>	cout &lt;&lt; test2 &lt;&lt; endl; <span class="hljs-comment">// prints: p\000werdns.com.</span></code></pre>
<a class="target" name="dnstype,rcode,dnssection">&nbsp;</a><a class="target" name="objectsintdns/dnstype,rcode,dnssection">&nbsp;</a><a class="target" name="toc2.3">&nbsp;</a><h2>DNSType, RCode, DNSSection</h2>
<p>

These is an enums that contains the names and numerical values of the DNS
types and error codes.  This means for example that <code>DNSType::A</code> corresponds
to 1 and <code>DNSType::SOA</code> to 6.

</p><p>

To make life a little bit easier, an operator has been defined which allows
the printing of <code>DNSTypes</code> as symbolic names. Sample:

</p><pre class="listing backtick"><code><span class="line"></span>	<span class="hljs-type">DNSType</span> a <span class="hljs-operator">=</span> <span class="hljs-type">DNSType</span>::<span class="hljs-type">CNAME</span>;
<span class="line"></span>	cout <span class="hljs-operator">&lt;&lt;</span> a <span class="hljs-operator">&lt;&lt;</span> <span class="hljs-string">"<span class="hljs-subst">\n</span>"</span>;    <span class="hljs-comment">// prints: CNAME</span>
<span class="line"></span>
<span class="line"></span>	a <span class="hljs-operator">=</span> (<span class="hljs-type">DNSType</span>) <span class="hljs-number">6</span>;
<span class="line"></span>	cout <span class="hljs-operator">&lt;&lt;</span> a <span class="hljs-operator">&lt;&lt;</span><span class="hljs-string">" is "</span><span class="hljs-operator">&lt;&lt;</span> (int)a <span class="hljs-operator">&lt;&lt;</span> <span class="hljs-string">"<span class="hljs-subst">\n</span>"</span>; <span class="hljs-comment">// prints: SOA is 6</span></code></pre><p>

Similar enums are defined for RCodes (response codes, RCode::Nxdomain for
example) and DNS Sections (Question, Answer, Nameserver/Authority,
Additional). These too can be printed.

</p>
<a class="target" name="tdig">&nbsp;</a><a class="target" name="objectsintdns/tdig">&nbsp;</a><a class="target" name="toc2.4">&nbsp;</a><h2><code>tdig</code></h2>
<p>

To discover how <code>tdns</code> works, let's start with the basics: sending DNS
queries and parsing responses. For this purpose, the <code>tdig</code> tool is
provided, somewhat modelled after the famous <code>dig</code> program created by ISC.

</p><p>

The code:
</p><pre class="listing backtick"><code><div class=" linenumbers"><span class="line"></span>	<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span>
<span class="line"></span>	</span>{
<span class="line"></span>		<span class="hljs-comment">/* ... */</span>
<span class="line"></span>		DNSName dn = <span class="hljs-built_in">makeDNSName</span>(argv[<span class="hljs-number">1</span>]);
<span class="line"></span>		DNSType dt = <span class="hljs-built_in">makeDNSType</span>(argv[<span class="hljs-number">2</span>]);
<span class="line"></span>		<span class="hljs-function">ComboAddress <span class="hljs-title">server</span><span class="hljs-params">(argv[<span class="hljs-number">3</span>])</span></span>;
<span class="line"></span>
<span class="line"></span>		<span class="hljs-function">DNSMessageWriter <span class="hljs-title">dmw</span><span class="hljs-params">(dn, dt)</span></span>;
<span class="line"></span>		dmw.dh.rd = <span class="hljs-literal">true</span>;
<span class="line"></span>		dmw.<span class="hljs-built_in">setEDNS</span>(<span class="hljs-number">4000</span>, <span class="hljs-literal">false</span>);</div></code></pre><p>

This starts out with the basics: it reads a <code>DNSName</code> from the first
argument to <code>tdns</code>, a <code>DNSType</code> from the second and finally a server IP
address from the third argument.

</p><p>

With this knowledge, in line 8 we create a <code>DNSMessageWriter</code> to make a
question for query name <code>dn</code> and query type <code>dt</code>. In addition, we set the
'recursion desired' flag.

</p><p>

Finally on line 10, we indicate our support for up to 4000 byte responses,
but we set the 'DNSSEC Ok' flag to false.

</p><p>

Next, mechanics:

</p><pre class="listing backtick"><code><span class="line"></span><span class="hljs-number">1</span>	Socket sock(<span class="hljs-name">server</span>.sin4.sin_family, SOCK_DGRAM)<span class="hljs-comment">;</span>
<span class="line"></span><span class="hljs-number">2</span>	SConnect(<span class="hljs-name">sock</span>, server)<span class="hljs-comment">;</span>
<span class="line"></span><span class="hljs-number">3</span>	SWrite(<span class="hljs-name">sock</span>, dmw.serialize())<span class="hljs-comment">;</span>
<span class="line"></span><span class="hljs-number">4</span>	string resp = SRecvfrom(<span class="hljs-name">sock</span>, <span class="hljs-number">65535</span>, server)<span class="hljs-comment">;</span>
<span class="line"></span><span class="hljs-number">5</span>
<span class="line"></span><span class="hljs-number">6</span>	DNSMessageReader dmr(<span class="hljs-name">resp</span>)<span class="hljs-comment">;</span></code></pre><p>

In line 1 we create a datagram socket appropriate for the protocol of
<code>server</code>. This is based on a small set of socket wrappers called
<a href="https://github.com/ahuPowerDNS/simplesocket">simplesockets</a>. On line 2 we
connect and on line 3 we serialize our DNSMessageWriter and send the
resulting packet. On line 4 we receive a response.

</p><p>

Finally on line 6 we parse that response into a <code>DNSMessageReader</code>.

</p><pre class="listing backtick"><code><span class="line"></span><span class="hljs-number">1</span>	DNSSection rrsection<span class="hljs-comment">;</span>
<span class="line"></span><span class="hljs-number">2</span>	uint32_t <span class="hljs-meta">ttl</span><span class="hljs-comment">;</span>
<span class="line"></span><span class="hljs-number">3</span>
<span class="line"></span><span class="hljs-number">4</span>	dmr.getQuestion(<span class="hljs-meta">dn</span>, dt)<span class="hljs-comment">;</span>
<span class="line"></span><span class="hljs-number">5</span>
<span class="line"></span><span class="hljs-number">6</span>	cout&lt;&lt;<span class="hljs-string">"Received "</span> &lt;&lt; resp.size() &lt;&lt; <span class="hljs-string">" byte response with RCode "</span><span class="hljs-comment">;</span>
<span class="line"></span><span class="hljs-number">7</span>	cout &lt;&lt; (RCode)dmr.dh.rcode &lt;&lt; <span class="hljs-string">", qname "</span> &lt;&lt; <span class="hljs-meta">dn</span> &lt;&lt; <span class="hljs-string">", qtype "</span> &lt;&lt; dt &lt;&lt; endl<span class="hljs-comment">;</span>
<span class="line"></span><span class="hljs-number">8</span>	std::unique_ptr&lt; RRGen &gt; rr<span class="hljs-comment">;</span>
<span class="line"></span><span class="hljs-number">9</span>	<span class="hljs-meta">while</span>(dmr.getRR(rrsection, <span class="hljs-meta">dn</span>, dt, <span class="hljs-meta">ttl</span>, rr)) {
<span class="line"></span><span class="hljs-number">10</span>	  cout &lt;&lt; <span class="hljs-meta">dn</span>&lt;&lt; <span class="hljs-string">" IN "</span> &lt;&lt; dt &lt;&lt; <span class="hljs-string">" "</span> &lt;&lt; <span class="hljs-meta">ttl</span> &lt;&lt; <span class="hljs-string">" "</span> &lt;&lt; rr-&gt;toString() &lt;&lt; endl<span class="hljs-comment">;</span>
<span class="line"></span><span class="hljs-number">11</span>	}</code></pre><p>

On lines 1 and 2 we declare some variable we'll need later to actually
retrieve the resource records. On line 4 we retrieved the name and type we
received an answer for, and on line 6 this all is displayed.

</p><p>

Line 8 declares 'rr' ready to receive our Resource Records, which are then
retrieved using the <code>getRR</code> method from the <code>DNSMessageReader</code> on line 9.

</p><p>

On line 10 we print what we found. Note that the <code>RRGen</code> object helpfully
has a <code>toString()</code> method for human friendly output.

</p>
<a class="target" name="parsingandgeneratingdnsmessages">&nbsp;</a><a class="target" name="parsingandgeneratingdnsmessages">&nbsp;</a><a class="target" name="toc3">&nbsp;</a><h1>Parsing and generating DNS Messages</h1>
<p>

This code is in <a href="dnsmessages.cc">dnsmessages.cc</a>
and <a href="dnsmessages.hh">dnsmessages.hh</a>.

</p>
<a class="target" name="rrgens:dealingwithalltherecordtypes">&nbsp;</a><a class="target" name="parsingandgeneratingdnsmessages/rrgens:dealingwithalltherecordtypes">&nbsp;</a><a class="target" name="toc3.1">&nbsp;</a><h2><code>RRGen</code>s: dealing with all the record types</h2>
<p>

DNS knows many record types, so we need a unified interface that can pass
all of them. For this purpose, <code>tdns</code> uses <code>RRGen</code> instances. <code>RRGen</code>s are
classes, one for each record type, all deriving from the <code>RRGen</code> base.

</p><p>

Each <code>RRGen</code> has a method called <code>toString()</code> which emits the record's
contents in familiar 'zonefile' format.

</p><p>

<code>RRGen</code>s can be created using their specific instance types, for example
like this:

</p><pre class="listing backtick"><code><span class="line"></span>	<span class="hljs-function">ComboAddress <span class="hljs-title">ip</span><span class="hljs-params">(<span class="hljs-string">"203.0.113.1"</span>)</span></span>;
<span class="line"></span>	<span class="hljs-keyword">auto</span> agen = AGen::<span class="hljs-built_in">make</span>(ip);
<span class="line"></span>
<span class="line"></span>	cout &lt;&lt; agen-&gt;<span class="hljs-built_in">toString</span>() &lt;&lt; endl; <span class="hljs-comment">// prints 203.0.113.1</span>
<span class="line"></span>
<span class="line"></span>	<span class="hljs-keyword">auto</span> soagen = SOAGen::<span class="hljs-built_in">make</span>({<span class="hljs-string">"ns1"</span>, <span class="hljs-string">"powerdns"</span>, <span class="hljs-string">"com"</span>},
<span class="line"></span>		{<span class="hljs-string">"bert.hubert"</span>, <span class="hljs-string">"powerdns"</span>, <span class="hljs-string">"com"</span>}, <span class="hljs-number">2018102301</span>);</code></pre><p>

<code>RRGen</code>s also know how to serialize themselves from a <code>DNSMessageReader</code>, or how to
write themselves out to a <code>DNSMessageWriter</code>.

</p><p>

When reading DNS Messages (see below), <code>DNSMessageReader::getRR()</code> will
return <code>RRGen</code> instances to you, if you want to do more than print their
contents, you need to cast them to the specific type, for example:

</p><pre class="listing backtick"><code><span class="line"></span>  ComboAddress ret;
<span class="line"></span>  ret.sin4.sin_family = <span class="hljs-number">0</span>;
<span class="line"></span>  <span class="hljs-keyword">if</span>(auto ptr = dynamic_cast&lt;agen*&gt;(rr.<span class="hljs-keyword">get</span>()))
<span class="line"></span>    ret=ptr-&gt;getIP();
<span class="line"></span>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(auto ptr = dynamic_cast&lt;aaaagen*&gt;(rr.<span class="hljs-keyword">get</span>()))
<span class="line"></span>    ret=ptr-&gt;getIP();</code></pre><p>

This code from <code>tres</code> checks if a record is an IP or IPv6 address and
extracts the IP address - all without using ASCII.

</p>
<a class="target" name="dnsmessagereader">&nbsp;</a><a class="target" name="parsingandgeneratingdnsmessages/dnsmessagereader">&nbsp;</a><a class="target" name="toc3.2">&nbsp;</a><h2>DNSMessageReader</h2>
<p>

This class reads a DNS message, and makes available:

</p><p>

</p><ul>
 <li class="asterisk">The query name (qname) and type (qtype)
</li>
 <li class="asterisk">The dnsheader containing the flags
</li>
 <li class="asterisk">EDNS buffer size and value of DNSSEC Ok flag</li></ul>

<p></p><p>

Of specific security note, this is one area where we might potentially have
to do pointer arithmetic. For security purposes, <code>DNSMessageReader</code> uses
bounds checking access methods exclusively.

</p><p>

Somewhat unexpectedly, parsing a packet does not immediately give the user
access to the query and type of the query (or response). The reason for this
is that there are packets that have no query defined. So to get the query,
call <code>getQuery()</code>.

</p><p>

Getting resource records from a <code>DNSMessageReader</code> happens via <code>getRR</code> which
returns record details and a smart pointer to an <code>RRGen</code> instance (as
described above).

</p><p>

A good example of how <code>DNSMessageReader</code> works can be found in
<a href="dns-storage.hh"><code>tdig.cc</code></a>.

</p>
<a class="target" name="dnsmessagewriter">&nbsp;</a><a class="target" name="parsingandgeneratingdnsmessages/dnsmessagewriter">&nbsp;</a><a class="target" name="toc3.3">&nbsp;</a><h2>DNSMessageWriter</h2>
<p>

This class creates DNS messages, and in its constructor it needs to know the
name and type it is creating a message for.

</p><p>

Packets are only written in order. So it is not possible to
change the <code>qname</code> after adding a resource record. Resource records must
also be added together as RRSets, and in 'section order'.

</p><p>

Internally <code>DNSMessageWriter</code> again only uses bounds checked methods for
modifying its state.

</p><p>

A <code>DNSMessageWriter</code> has a maximum length (set via its constructor).  If new
resource record, as written by <code>putRR</code>, would exceed this maximum length,
that record is rolled back and a std::out_of_range() exception is thrown.
This allows the caller to either truncate or decide this data was optional
anyhow.

</p><p>

Writing actual records to DNSMessageWriter proceeds via <code>putRR()</code> which
serializes <code>RRGen</code> instances to the message.

</p><p>

Samples of how to do this can be found in
<a href="dns-storage.hh">tres.cc</a>
and
<a href="dns-storage.hh">tauth.cc</a>.

</p>
<a class="target" name="compression">&nbsp;</a><a class="target" name="parsingandgeneratingdnsmessages/dnsmessagewriter/compression">&nbsp;</a><a class="target" name="toc3.3.1">&nbsp;</a><h3>Compression</h3>
<p>

DNS compression is unreasonably difficult to get right. In what happens to
be a coincidence, it turns out the DNS Tree can also be used to perform
DNS name compression.

</p><p>

For every invocation of <code>putName()</code> in <code>DNSMessageWriter()</code> we check the DNS
tree if it has a match on the full name, and if not, we add the name
and its components of the name to a DNS tree.

</p><p>

This effectively gets us the desired compression behaviour, except special
care has to be taken to not do wildcard processing.

</p>
<a class="target" name="ednsandtruncation">&nbsp;</a><a class="target" name="parsingandgeneratingdnsmessages/ednsandtruncation">&nbsp;</a><a class="target" name="toc3.4">&nbsp;</a><h2>EDNS and truncation</h2>
<p>

EDNS tells us that a larger buffer size is available. However, even with
such a larger buffer size, a packet may exceed the available space. In that
case, the standard tells us to truncate the packet, and then still put an
EDNS record in the response.

</p><p>

The DNSMessageWriter, in somewhat of a layering violation, takes care of
this in <code>serialize()</code>.

</p>
<a class="target" name="internals">&nbsp;</a><a class="target" name="internals">&nbsp;</a><a class="target" name="toc4">&nbsp;</a><h1>Internals</h1>
<p>

<code>tdns</code> uses several small pieces of code not core to dns:

</p><p>

</p><ul>
 <li class="asterisk"><a href="nenum.hh">nenum</a>
    this is a simple 'named ENUM' construct that enables the printing of
    DNSName::A
</li>
 <li class="asterisk"><a href="https://github.com/ahupowerdns/simplesocket">Simplesocket</a> a small set
    of convenience functions for making sockets, parsing IP addresses etc.
</li>
 <li class="asterisk"><a href="https://github.com/catchorg/Catch2">Catch2</a> a unit test framework</li></ul>

<p></p>
<a class="target" name="compilingandrunningtdns">&nbsp;</a><a class="target" name="compilingandrunningtdns">&nbsp;</a><a class="target" name="toc5">&nbsp;</a><h1>Compiling and running tdns</h1>
<p>

This requires a recent compiler version that supports C++ 2014. If you
encounter problems, please let me know (see above for address details).

</p><pre class="listing backtick"><code><span class="line"></span><span class="hljs-meta prompt_">$ </span><span class="language-bash">git <span class="hljs-built_in">clone</span> https://github.com/ahupowerdns/hello-dns.git</span>
<span class="line"></span><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> hello-dns/tdns</span>
<span class="line"></span><span class="hljs-meta prompt_">$ </span><span class="language-bash">git submodule init</span>
<span class="line"></span><span class="hljs-meta prompt_">$ </span><span class="language-bash">git submodule update</span>
<span class="line"></span><span class="hljs-meta prompt_">$ </span><span class="language-bash">make</span>
<span class="line"></span><span class="hljs-meta prompt_">$ </span><span class="language-bash">./tauth [::1]:5300 &amp;</span>
<span class="line"></span><span class="hljs-meta prompt_">$ </span><span class="language-bash">dig -t any time.powerdns.org @::1 -p 5300 +short</span>
<span class="line"></span>time.powerdns.org.	3600	IN	TXT	"The time is Fri, 13 Apr 2018 12:55:54 +0200"</code></pre><p>

For more detauls, read on about <a href="tauth.html"><code>tauth</code></a>, <a href="tres.html"><code>tres</code></a>
or the <a href="c-api.html">C API</a>.

</p><p>

<script>
window.markdeepOptions={};
window.markdeepOptions.tocStyle = &ldquo;long&rdquo;;
</script>
</p></span><div id="mdContextMenu" style="visibility:hidden"></div><div class="markdeepFooter"><i>formatted by <a href="https://casual-effects.com/markdeep" style="color:#999">Markdeep&nbsp;1.16&nbsp;&nbsp;</a></i><div style="display:inline-block;font-size:13px;font-family:'Times New Roman',serif;vertical-align:middle;transform:translate(-3px,-1px)rotate(135deg);">✒</div></div></body></html>
